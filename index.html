<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Equipment Log</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<style>
  :root{
    --bg:#f6f7f8; --paper:#fff; --ink:#111827; --muted:#6b7280; --line:#e5e7eb;
    --thead:#f3f4f6; --row-alt:#fafafa;
  }
  *{ box-sizing:border-box }
  html,body{ min-height:100% }
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font:13.5px/1.45 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    -webkit-print-color-adjust:exact; print-color-adjust:exact;
  }
  .sheet{
    width:900px; max-width:95vw; margin:22px auto;
    background:var(--paper); border:1px solid var(--line); border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,.05);
    padding:28px 32px 26px;
  }

  .header{ display:grid; grid-template-columns:1fr auto; gap:12px; align-items:center }
  .brand{ display:flex; gap:12px; align-items:center }
  .logo{
    width:56px; height:56px; border:1px solid var(--line); border-radius:12px;
    display:grid; place-items:center; overflow:hidden; background:#fff
  }
  .logo:empty{ display:none }
  .logo img{ max-width:100%; max-height:100%; object-fit:contain }
  .t1{ font-size:20px; font-weight:800; letter-spacing:.02em }

  /* smaller title */
  .inv-title{ font-size:24px; letter-spacing:.04em; font-weight:900; color:var(--ink) }

  .divider{ height:3px; border-radius:3px; margin:12px 0 10px; background:linear-gradient(90deg,#2f2f2f 0 15%, #c7c9cc 15% 100%); }
  .meta-mini{ margin:0 0 10px; color:#374151; font-size:13px }
  .meta-mini strong{ font-weight:800 }

  /* sort pill */
  .sort-row{ display:flex; justify-content:flex-end; margin:6px 0 14px; }
  .pill{
    background:#e5e7eb; color:#374151; padding:8px 14px; border-radius:9999px;
    font-size:13px; display:inline-block;
  }

  table{ width:100%; border-collapse:collapse }
  thead th{
    text-transform:uppercase; letter-spacing:.05em; font-size:10.5px; color:#4b5563;
    border-bottom:none; padding:8px 10px; background:var(--thead); text-align:center;
  }
  tbody td{ padding:9px 10px; border-bottom:1px solid #eceff1; text-align:center; vertical-align:middle; font-size:12.5px }
  tbody td.desc-cell{ text-align:left }
  tbody tr:nth-child(2n){ background:var(--row-alt) }
  td.num{ white-space:nowrap }

  @media print {
    @page { size:A4 portrait; margin:5mm }
    .sheet{ width:200mm; margin:0 auto; padding:3mm 4mm 5mm; border:none; box-shadow:none }
    body{ font-size:12.5px }
    thead th{ font-size:10px }
    tbody td{ padding:6px }
    tr,td,th{ page-break-inside:avoid; break-inside:avoid }
  }
  @supports (-webkit-touch-callout:none){
    @media print { body{ zoom:.88 } .sheet{ width:auto; max-width:none; padding:3mm } }
  }
</style>
</head>
<body>
  <div class="sheet">
    <header class="header">
      <div class="brand">
        <div class="logo" id="logo_box"></div>
        <div class="t1" id="brand_name"></div>
      </div>
      <div class="right"><div class="inv-title" id="page_title">EQUIPMENT LOG</div></div>
    </header>
    <div class="divider"></div>

    <div class="meta-mini">
      <strong>Log created on:</strong> <span id="log_dt"></span>
    </div>

    <!-- <div class="sort-row">
  <span class="pill">Sort by Return Date in descending order</span>
    </div> -->


    <table>
      <thead>
        <tr>
          <th>Category</th>
          <th>Name</th>
          <th>Model</th>
          <th>Serial</th>
          <th>Member</th>
          <th>Allocated</th>
          <th>Return</th>
          <th>Days</th>
          <th>Notes (Alloc)</th>
          <th>Notes (Return)</th>
        </tr>
      </thead>
      <tbody id="equip_body"></tbody>
    </table>
  </div>

<script>
  const qp = new URLSearchParams(location.search);
  const get = (k,d='') => qp.get(k) ?? d;

  // Brand + title (hide brand name if absent)
  (function(){
    const name=(get('my_Co_name','')||'').trim();
    const el=document.getElementById('brand_name');
    if(name){ el.textContent=name; el.style.display=''; }
    else { el.textContent=''; el.style.display='none'; }
    const title=(get('title_report','')||'').trim();
    document.getElementById('page_title').textContent = title || 'EQUIPMENT LOG';
  })();

  // Logo (hide if absent)
  (function(){
    const box=document.getElementById('logo_box');
    const url=(get('my_Co_logo','')||'').trim();
    if(url){
      const img=new Image(); img.alt='logo';
      img.onload=()=>{ box.innerHTML=''; box.appendChild(img); };
      img.onerror=()=>{ box.style.display='none'; };
      img.src=url;
    }else box.style.display='none';
  })();

  // Created on (date + time, local)
  (function(){
    const d=new Date();
    const months=["January","February","March","April","May","June","July","August","September","October","November","December"];
    const dd=String(d.getDate()).padStart(2,'0');
    const hh=String(d.getHours()).padStart(2,'0');
    const mm=String(d.getMinutes()).padStart(2,'0');
    document.getElementById('log_dt').textContent = `${dd} ${months[d.getMonth()]} ${d.getFullYear()}, ${hh}:${mm}`;
  })();

  // Parse items (?items= rows '||', fields '::')
  function parse(str){
    if(!str) return [];
    const rowSep=/(\|\||%7C%7C)/i, colSep=/(::|%3A%3A)/i;
    const rows=str.split(rowSep).filter(s=>!rowSep.test(s) && s!=='');
    const decode = s => decodeURIComponent((s||'').trim());
    return rows.map(line => {
      const parts=line.split(colSep).filter(s=>!colSep.test(s)).map(decode);
      const c = Array.from({length:10},(_,i)=>parts[i]||'');
      return {cat:c[0],name:c[1],model:c[2],serial:c[3],member:c[4],alloc:c[5],ret:c[6],days:c[7],nAlloc:c[8],nRet:c[9]};
    });
  }

  // Robust date parser (handles ISO and "Month D, YYYY")
  function ts(dateStr){
    if(!dateStr) return -Infinity;
    const d=new Date(dateStr);
    if(!isNaN(d)) return d.getTime();
    // try DD/MM/YYYY quick fallback
    const m=dateStr.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
    if(m){
      const [_,dd,mm,yy]=m;
      return new Date(Number(yy), Number(mm)-1, Number(dd)).getTime();
    }
    return -Infinity;
  }

  const data = parse(get('items',''));

  // Sort by Return Date DESC
  data.sort((a,b)=> ts(b.ret) - ts(a.ret));

  // Render
  (function(){
    const tbody=document.getElementById('equip_body');
    const esc=s=>String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    data.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${esc(r.cat)}</td>
        <td>${esc(r.name)}</td>
        <td>${esc(r.model)}</td>
        <td>${esc(r.serial)}</td>
        <td>${esc(r.member)}</td>
        <td>${esc(r.alloc)}</td>
        <td>${esc(r.ret)}</td>
        <td>${esc(r.days)}</td>
        <td class="desc-cell">${esc(r.nAlloc)}</td>
        <td class="desc-cell">${esc(r.nRet)}</td>`;
      tbody.appendChild(tr);
    });
  })();

  // Auto-print
  if(/^(1|true)$/i.test((get('print','')||'').trim())){
    window.addEventListener('load', ()=>{ try{ setTimeout(()=>window.print(),0) }catch{} });
  }
</script>
</body>
</html>
